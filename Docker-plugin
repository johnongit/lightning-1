FROM johnonchain/lightning:v0.12.1


RUN apt-get update && apt-get install -y --no-install-recommends default-jdk libffi-dev libleveldb-dev libev-dev libpq5 \
    libsodium-dev libpq-dev git socat inotify-tools python3 python3-pip python3-setuptools build-essential python3-dev python3-wheel python3-venv dnsutils curl libsecp256k1-0 pkg-config libssl-dev \
    libuv1 \    
    && curl -sL https://deb.nodesource.com/setup_19.x  | bash - && \
    apt-get -y install nodejs &&\
    rm -rf /var/lib/apt/lists/*
# Install watchtower client
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"


RUN git clone https://github.com/talaia-labs/rust-teos && \
    cd rust-teos && \
    cargo install --locked --path watchtower-plugin


RUN mkdir -p /python-plugin/plugins  && \
    git clone https://github.com/talaia-labs/python-teos.git && \
    cd python-teos &&  pip3 install -r requirements.txt && \
    cd watchtower-plugin && pip3 install -r requirements.txt && \
    pip3 install pyln-client==0.10.1 && \
    cd /python-teos && COMMON_ONLY=1 pip3 install . 

## Install cln-rest for RTL
RUN mkdir -p /python-plugin/plugins \
    && cd /python-plugin/plugins && \
    git clone https://github.com/Ride-The-Lightning/c-lightning-REST.git && \
    cd c-lightning-REST && \
    git checkout v0.9.0 && \
    npm install


## Install btcli4j
RUN git clone https://github.com/clightning4j/btcli4j.git /plugins/btcli4j && \
    cd /plugins/btcli4j && \
    ./gradlew --stacktrace createRunnableScript


ENV LIGHTNINGD_DATA=/root/.lightning
ENV LIGHTNINGD_RPC_PORT=9835
ENV LIGHTNINGD_PORT=9735
ENV LIGHTNINGD_NETWORK=bitcoin

VOLUME [ "/root/.lightning" ]


COPY tools/docker-entrypoint.sh entrypoint.sh

EXPOSE 9735 9835 9737
ENTRYPOINT  [ "/usr/bin/tini", "-g", "--", "./entrypoint.sh" ]
